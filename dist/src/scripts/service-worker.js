import{LocalStorage}from"./storage.js";import{Url}from"./url.js";import{firestore,add_data,userOnlineData,isProjectLive,start_project}from"./firebase.js";var projectId,userEmail,userId,storage=new LocalStorage,userTimeline=[],trackUserInMillis=5e3,uploadDataInMillis=6e5,userOnlineDataTrackMillis=3e4,USER_TIMELINE="user_timeline",USER_OFF_SCREEN="user_off_screen",PROJECT_ID="projectId",USER_EMAIL="userEmail",USER_ID="userId",USER_AUTHENTICATED="userAuthenticated";async function getCurrentTabUrl(){let e="";try{let t={active:!0,currentWindow:!0},[r]=await chrome.tabs.query(t);console.log("tab",r),e=null==r?USER_OFF_SCREEN:r.url}catch(e){console.log("gettting tab value error"),console.error(e)}return console.log("tracking tab",e),e}function setUserData(){storage.getValue(PROJECT_ID,(function(e){console.log(`setUserData PROJECT_ID ${e}`),projectId=e})),storage.getValue(USER_EMAIL,(function(e){userEmail=e})),storage.getValue(USER_ID,(function(e){userId=e}))}function unsetUserData(){storage.removeValue(PROJECT_ID),storage.removeValue(USER_EMAIL),storage.removeValue(USER_ID),projectId=void 0,userEmail=void 0,userId=void 0,console.log(`user data is unset $${userId}, ${userEmail}, ${projectId}`)}function unsetProjectData(){storage.removeValue(PROJECT_ID),projectId=void 0,console.log(`project data is unset $${userId}, ${userEmail}, ${projectId}`)}async function addTabToUserTimeline(){if(setUserData(),null!=projectId&&null!=userEmail){var e=new Url(await getCurrentTabUrl()).host,t={timeStamp:Date.now(),url:e};userTimeline.push(t),storage.saveValue(USER_TIMELINE,userTimeline)}}async function getCurrentTab(){let[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return e}async function addData(){if(setUserData(),console.log(`addData ${projectId} ${userEmail}`),null!=projectId&&null!=userEmail){"Ended"==e&&unsetProjectData();var e=(await isProjectLive(projectId)).status;"Live"==e&&addDataWithProjectId(projectId)}console.log("data added")}async function checkUserOnline(){setUserData(),console.log(`Inside checkUserOnline ${projectId} ${userEmail}`),null!=projectId&&null!=userEmail&&(console.log("Inside of inside checkUserOnline if"),userOnlineData(userEmail,userId,projectId))}async function addDataWithProjectId(e){setUserData(),storage.getValue(USER_TIMELINE,(async function(t){null!=(await add_data(userEmail,userId,t,e)).id&&(userTimeline=[])}))}function trackCurrentActivity(){setInterval(addTabToUserTimeline,trackUserInMillis)}function showUserActivity(){storage.getValue(USER_TIMELINE,(function(e){})),getMemoryUsed()}function getMemoryUsed(){storage.getMemoryUse(USER_TIMELINE,(function(e){console.log((e/1024).toFixed(2)+"Kb")}))}function uploadData(){setInterval(addData,uploadDataInMillis)}function userOnline(){setInterval(checkUserOnline,userOnlineDataTrackMillis)}let lifeline;function keepAliveForced(){lifeline?.disconnect(),lifeline=null,keepAlive()}async function keepAlive(){if(!lifeline){for(const e of await chrome.tabs.query({url:"*://tools.sabertechs.com/*"}))try{return console.log(`Keep alive function ${e.url}`),await chrome.scripting.executeScript({target:{tabId:e.id},function:()=>chrome.runtime.connect({name:"keepAlive"})}),void chrome.tabs.onUpdated.removeListener(retryOnTabUpdate)}catch(e){}chrome.tabs.onUpdated.addListener(retryOnTabUpdate)}}async function retryOnTabUpdate(e,t,r){t.url&&/^(file|https?):/.test(t.url)&&keepAlive()}console.log("firestore collection is fetched SW",firestore),unsetUserData(),trackCurrentActivity(),uploadData(),userOnline(),keepAlive(),chrome.runtime.onConnect.addListener((e=>{"keepAlive"===e.name&&(lifeline=e,setTimeout(keepAliveForced,85e3),e.onDisconnect.addListener(keepAliveForced)),"StartProject"===e.name&&e.onMessage.addListener((function(e){start_project(e.projectId,e.userId),console.log(`StartProject msg ${e}`),storage.saveValue(PROJECT_ID,e.projectId),storage.saveValue(USER_EMAIL,e.userEmail),storage.saveValue(USER_ID,e.userId),console.log(`item set StartProject ${e}`)})),"StopProject"===e.name&&(setUserData(),e.onMessage.addListener((function(e){console.log(`StopProject ${e} `),console.log(`item set StopProject ${e}`)})),null!=projectId&&(console.log(`addDataWithProjectId ${projectId}`),addDataWithProjectId(projectId)),unsetUserData())}));